<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.290">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Mark Spillman">
<meta name="dcterms.date" content="2023-09-01">
<meta name="description" content="Neural networks can be used to remove both background scattering and experimental noise from powder X-ray diffraction data.">

<title>Mark Spillman - Background subtraction and denoising PXRD data with UNets</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EVMREB130B"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-EVMREB130B', { 'anonymize_ip': true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Mark Spillman</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../publications.html" rel="" target="">
 <span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/mspillman" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/mspillman" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../index.xml" rel="" target=""><i class="bi bi-rss" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Background subtraction and denoising PXRD data with UNets</h1>
                  <div>
        <div class="description">
          Neural networks can be used to remove both background scattering and experimental noise from powder X-ray diffraction data.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">PXRD</div>
                <div class="quarto-category">Background subtraction</div>
                <div class="quarto-category">Machine learning</div>
                <div class="quarto-category">Neural network</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Mark Spillman </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">September 1, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#modifying-unet-for-pxrd-data" id="toc-modifying-unet-for-pxrd-data" class="nav-link" data-scroll-target="#modifying-unet-for-pxrd-data">Modifying UNet for PXRD data</a></li>
  <li><a href="#training-data" id="toc-training-data" class="nav-link" data-scroll-target="#training-data">Training data</a>
  <ul class="collapse">
  <li><a href="#diffraction-data" id="toc-diffraction-data" class="nav-link" data-scroll-target="#diffraction-data">Diffraction data</a></li>
  <li><a href="#filtering-powcod-data" id="toc-filtering-powcod-data" class="nav-link" data-scroll-target="#filtering-powcod-data">Filtering PowCod data</a></li>
  <li><a href="#loading-data" id="toc-loading-data" class="nav-link" data-scroll-target="#loading-data">Loading data</a></li>
  <li><a href="#peak-positions" id="toc-peak-positions" class="nav-link" data-scroll-target="#peak-positions">Peak positions</a></li>
  <li><a href="#peak-intensities" id="toc-peak-intensities" class="nav-link" data-scroll-target="#peak-intensities">Peak intensities</a></li>
  <li><a href="#peak-shapes" id="toc-peak-shapes" class="nav-link" data-scroll-target="#peak-shapes">Peak shapes</a></li>
  <li><a href="#misc" id="toc-misc" class="nav-link" data-scroll-target="#misc">Misc</a></li>
  <li><a href="#background" id="toc-background" class="nav-link" data-scroll-target="#background">Background</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Neural networks have become a powerful tool for automating complex tasks in crystallography, especially as applied to PXRD data. For example, <a href="https://scripts.iucr.org/cgi-bin/paper?vb5020">indexing</a>, <a href="https://www.nature.com/articles/s41524-021-00542-4">crystallite size and scale factor</a> determination, as well as <a href="https://journals.aps.org/prb/abstract/10.1103/PhysRevB.99.245120">crystal system and space group</a> <a href="https://journals.iucr.org/m/issues/2017/04/00/fc5018/index.html">classification</a>. There are many more examples in the literature! Modern approaches typically make use of architectures built from convolutional layers, which are well suited to 1D PXRD data.</p>
<p>In this post, we’ll look at using neural networks to automatically remove both the amorphous scattering background and experimental noise from PXRD data. Subtracting backgrounds (or at least effectively modelling them) is required for SDPD (for example using GALLOP) to proceed - this is because extracting accurate intensities for the scattering phase of interest from the diffraction data is critical. Traditionally, background removal is done manually by fitting smooth functions to estimate the background - this process is subjective; it takes experience and expertise to understand and determine when the fit to the background is “good enough”. We’re going to look at using neural networks to automate this process.</p>
<p>The <a href="https://arxiv.org/abs/1505.04597">UNet</a> architecture is well-suited for image-to-image tasks, and was originally designed for segmenting biomedical images.</p>
<p><img src="./images/UNet.png" class="quarto-discovered-preview-image img-fluid"></p>
<p>The UNet design has several advantages: - Encoder-decoder structure: The encoder gradually compresses the input image into a smaller latent representation, while the decoder gradually reconstructs the image from this representation. This allows the model to learn robust features for denoising in the encoder, while preserving high resolution details in the decoder. - Skip connections: UNet has skip connections that concatenate encoder and decoder features at each stage. This allows low-level features to be propagated across the model, preserving fine details and improving pixel-level prediction. - Convolutional layers: UNet uses convolutional layers which are ideal for learning spatially-localised features in images. Convolutions help the model learn effective filters for removing background noise. - End-to-end learning: UNet can be trained end-to-end directly on noisy and clean PXRD image pairs. This allows the model to learn the optimal filters for denoising the specific data, without manual feature engineering. - Fast inference: Once trained, UNet can denoise images quickly in a feedforward pass. This allows near real-time processing of large PXRD datasets.</p>
<p>Overall, the UNet architecture provides an excellent balance of contextual feature learning while preserving detailed pixel-level information critical for image denoising tasks. In this blog post, I will discuss how UNet can be adapted for use with PXRD data, and trained on noisy and clean PXRD patterns to automate background subtraction.</p>
</section>
<section id="modifying-unet-for-pxrd-data" class="level1">
<h1>Modifying UNet for PXRD data</h1>
<p>While UNet was originally designed for 2D image inputs, we can adapt it for 1D PXRD data by modifying the convolutional layers. Specifically, we replace the 2D convolutional layers with 1D equivalents. I also opted to replace the individual convolutional layers in the original UNet with 1D versions of <a href="https://arxiv.org/abs/2301.00808">ConvNeXt V2 blocks</a>, which have been used to significantly improve the performance of convolutional neural networks on image classification, object detection and image segmentation tasks.</p>
<p><img src="./images/ConvNeXtV2_block.png" class="img-fluid"></p>
<p>In this work, the ConvNeXt V2 block is modified to use 1D convolutions. Like the original ConvNeXt V2 block, the middle dimension expansion layer has 4 x the number of channels compared to the input layer. The output layer may have more channels than the input later. Where this is the case, the skip connection shown is modified to use a 1D convolution with kernel size 1 to project the input to the appropriate number of dimensions before addition. Using these modified blocks, I ended up with the following architecture:</p>
<p><img src="./images/Unet.drawio.png" class="img-fluid"></p>
<p>In total, the neural network has approximately 1 million parameters. This relatively low number of parameters is due to the parameter-efficient ConvNeXt V2 blocks, and the relatively simple task that it has been applied to. I’ve provided the pytorch code for the neural network below.</p>
<div class="cell" data-execution_count="1">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> nn</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GRN(nn.Module):</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># global response normalization, proposed in updated convnext paper</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Code adapted from https://github.com/lucidrains/x-unet/blob/main/x_unet/x_unet.py</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Modified to work with 1D data</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, dim, eps <span class="op">=</span> <span class="fl">1e-6</span>):</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.eps <span class="op">=</span> eps</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.gamma <span class="op">=</span> nn.Parameter(torch.zeros(<span class="dv">1</span>, dim, <span class="dv">1</span>))</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.bias <span class="op">=</span> nn.Parameter(torch.zeros(<span class="dv">1</span>, dim, <span class="dv">1</span>))</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Input is Batch,Channels,Length</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Want to average first over length, then divide by average channel</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>        spatial_l2_norm <span class="op">=</span> x.norm(p <span class="op">=</span> <span class="dv">2</span>, dim <span class="op">=</span> (<span class="dv">2</span>), keepdim <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>        feat_norm <span class="op">=</span> spatial_l2_norm <span class="op">/</span> spatial_l2_norm.mean(dim <span class="op">=</span> <span class="dv">1</span>, keepdim <span class="op">=</span> <span class="va">True</span>).clamp(<span class="bu">min</span> <span class="op">=</span> <span class="va">self</span>.eps)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>        val <span class="op">=</span> x <span class="op">*</span> feat_norm <span class="op">*</span> <span class="va">self</span>.gamma <span class="op">+</span> <span class="va">self</span>.bias <span class="op">+</span> x</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> val</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> conv_block(nn.Module):</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, in_c, out_c, dim):</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.depth_1 <span class="op">=</span> nn.Conv1d(in_channels<span class="op">=</span>in_c, out_channels<span class="op">=</span>in_c, kernel_size<span class="op">=</span><span class="dv">7</span>, groups<span class="op">=</span>in_c, padding<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.point_1 <span class="op">=</span> nn.Conv1d(in_channels<span class="op">=</span>in_c, out_channels<span class="op">=</span>in_c, kernel_size<span class="op">=</span><span class="dv">1</span>, padding<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv1_1 <span class="op">=</span> nn.Conv1d(in_c, <span class="dv">4</span><span class="op">*</span>in_c, kernel_size<span class="op">=</span><span class="dv">1</span>, padding<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv2_1 <span class="op">=</span> nn.Conv1d(<span class="dv">4</span><span class="op">*</span>in_c, in_c, kernel_size<span class="op">=</span><span class="dv">1</span>, padding<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ln_1 <span class="op">=</span> nn.LayerNorm((in_c,dim))</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.GRN_1 <span class="op">=</span> GRN(<span class="dv">4</span><span class="op">*</span>in_c)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.gelu <span class="op">=</span> nn.GELU()</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> in_c <span class="op">!=</span> out_c:</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.shortcut <span class="op">=</span> nn.Conv1d(in_c, out_c, kernel_size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.shortcut <span class="op">=</span> nn.Identity()</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, inputs):</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.depth_1(inputs)</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.point_1(x)</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.ln_1(x)</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.conv1_1(x)</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.gelu(x)</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.GRN_1(x)</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.conv1_2(x)</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> x <span class="op">+</span> <span class="va">self</span>.shortcut(inputs)</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> encoder_block(nn.Module):</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, in_c, out_c, dim):</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv <span class="op">=</span> conv_block(in_c, out_c, dim)</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.down <span class="op">=</span> nn.Conv1d(out_c, out_c, kernel_size<span class="op">=</span><span class="dv">2</span>, stride<span class="op">=</span><span class="dv">2</span>, padding<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, inputs):</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.conv(inputs)</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>        p <span class="op">=</span> <span class="va">self</span>.down(x)</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x, p</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> decoder_block(nn.Module):</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, in_c, out_c, dim):</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.up <span class="op">=</span> nn.ConvTranspose1d(in_c, out_c, kernel_size<span class="op">=</span><span class="dv">2</span>, stride<span class="op">=</span><span class="dv">2</span>, padding<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv <span class="op">=</span> conv_block(out_c<span class="op">+</span>out_c, out_c, dim)</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, inputs, skip):</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.up(inputs)</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> torch.cat([x, skip], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.conv(x)</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> build_unet(nn.Module):</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, channels, dim):</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.inputs <span class="op">=</span> conv_block(<span class="dv">1</span>, channels, dim)</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Encoder</span></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.e1 <span class="op">=</span> encoder_block(channels, channels, dim)</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.e2 <span class="op">=</span> encoder_block(channels, channels<span class="op">*</span><span class="dv">2</span>, dim<span class="op">//</span><span class="dv">2</span>)</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.e3 <span class="op">=</span> encoder_block(channels<span class="op">*</span><span class="dv">2</span>, channels<span class="op">*</span><span class="dv">4</span>, dim<span class="op">//</span><span class="dv">4</span>)</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.e4 <span class="op">=</span> encoder_block(channels<span class="op">*</span><span class="dv">4</span>, channels<span class="op">*</span><span class="dv">8</span>, dim<span class="op">//</span><span class="dv">8</span>)</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Middle</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.b <span class="op">=</span> conv_block(channels<span class="op">*</span><span class="dv">8</span>, channels<span class="op">*</span><span class="dv">16</span>, dim<span class="op">//</span><span class="dv">16</span>)</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Decoder</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.d1 <span class="op">=</span> decoder_block(channels<span class="op">*</span><span class="dv">16</span>, channels<span class="op">*</span><span class="dv">8</span>, dim<span class="op">//</span><span class="dv">8</span>)</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.d2 <span class="op">=</span> decoder_block(channels<span class="op">*</span><span class="dv">8</span>, channels<span class="op">*</span><span class="dv">4</span>, dim<span class="op">//</span><span class="dv">4</span>)</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.d3 <span class="op">=</span> decoder_block(channels<span class="op">*</span><span class="dv">4</span>, channels<span class="op">*</span><span class="dv">2</span>, dim<span class="op">//</span><span class="dv">2</span>)</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.d4 <span class="op">=</span> decoder_block(channels<span class="op">*</span><span class="dv">2</span>, channels, dim)</span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Output</span></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_1 <span class="op">=</span> conv_block(channels, channels, dim)</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_2 <span class="op">=</span> conv_block(channels, channels, dim)</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output_3 <span class="op">=</span> nn.Conv1d(channels, <span class="dv">1</span>, kernel_size<span class="op">=</span><span class="dv">7</span>, padding<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, src):</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>        inputs <span class="op">=</span> <span class="va">self</span>.inputs(src)</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Encoder</span></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>        s1, p1 <span class="op">=</span> <span class="va">self</span>.e1(inputs)</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>        s2, p2 <span class="op">=</span> <span class="va">self</span>.e2(p1)</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>        s3, p3 <span class="op">=</span> <span class="va">self</span>.e3(p2)</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>        s4, p4 <span class="op">=</span> <span class="va">self</span>.e4(p3)</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Middle</span></span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>        b <span class="op">=</span> <span class="va">self</span>.b(p4)</span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Decoder</span></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>        d1 <span class="op">=</span> <span class="va">self</span>.d1(b, s4)</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>        d2 <span class="op">=</span> <span class="va">self</span>.d2(d1, s3)</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>        d3 <span class="op">=</span> <span class="va">self</span>.d3(d2, s2)</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>        d4 <span class="op">=</span> <span class="va">self</span>.d4(d3, s1)</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Output</span></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> <span class="va">self</span>.output_1(d4)</span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> <span class="va">self</span>.output_2(output)</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> <span class="va">self</span>.output_3(output)</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> output</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="training-data" class="level1">
<h1>Training data</h1>
<section id="diffraction-data" class="level2">
<h2 class="anchored" data-anchor-id="diffraction-data">Diffraction data</h2>
<p>I used the <a href="https://www.researchgate.net/publication/273507012_QUALX20_A_qualitative_phase_analysis_software_using_the_freely_available_database_POW-COD">PowCod database</a> produced by the <a href="https://www.ba.ic.cnr.it/softwareic/qualx/powcod-download/">Bari group</a> as the source for the training data. This database contains diffraction data for a large number of crystal structures obtained from the <a href="http://www.crystallography.net/cod/">crystallography open database</a>, and made this project much easier than it otherwise would be. PowCod provides lots of information, most pertinent for this work is the unit cells, space groups, Miller indices and associated intensities for all of the crystal structures. I applied some filtering to this, and ended up with a dataset comprising 258k diffraction patterns.</p>
<p>I wrote some PyTorch-based code to generate relatively realistic looking PXRD data on-the-fly using my GPU. I’ve included several methods of data augmentation:</p>
<ul>
<li>Modification of unit cells to simulate thermal expansion / contraction</li>
<li>Modification of noise to simulate different experimental data collection times / sample sizes</li>
<li>Modification of peak shapes, broadening and asymmetry to simulate different crystallite sizes and strains and instrumentation (full Voigt peaks are calculated with axial divergence using the method published by <a href="https://scripts.iucr.org/cgi-bin/paper?hn0025">Finger et al.</a>)</li>
<li>Modification of zero point errors to simulate different instruments</li>
<li>Modification of intensities using the March-Dollase method to simulate preferred orientation effects</li>
</ul>
<p>In the next sections, we’ll see how I filtered the original dataset, and then go over the code used to generate the relatively realistic looking diffraction data.</p>
</section>
<section id="filtering-powcod-data" class="level2">
<h2 class="anchored" data-anchor-id="filtering-powcod-data">Filtering PowCod data</h2>
<p>The PowCod dataset, which can be obtained here, is made up of several .sql files which need to be parsed to extract the desired information. In our case, what we are after is: - Unit cells - Crystal systems - Miller indices - Intensities</p>
<p>We’ll probably also need to use some additional information to help us along the way, for example, the d-spacing of the reflections.</p>
<p>As the files total only around 5.5 GB, I used pandas to read the database into memory and extract the information needed. I pickled the resultant dataframe to enable it to be more easily read in the future.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_powcod_sql():</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> sqlite3</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    con <span class="op">=</span> sqlite3.<span class="ex">connect</span>(<span class="st">'cod2205.sq'</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_sql_query(<span class="st">'SELECT * FROM id'</span>,con)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    con2 <span class="op">=</span> sqlite3.<span class="ex">connect</span>(<span class="st">'cod2205.sq.info'</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    df2 <span class="op">=</span> pd.read_sql_query(<span class="st">'SELECT * FROM info'</span>,con2)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    df.<span class="bu">id</span> <span class="op">=</span> pd.to_numeric(df.<span class="bu">id</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    df2.<span class="bu">id</span> <span class="op">=</span> pd.to_numeric(df2.<span class="bu">id</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    combined <span class="op">=</span> df.merge(df2, left_on<span class="op">=</span><span class="st">"id"</span>, right_on<span class="op">=</span><span class="st">"id"</span>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> combined</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> os.path.isfile(<span class="st">"combined.pkl"</span>):</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    combined <span class="op">=</span> pd.read_pickle(<span class="st">"combined.pkl"</span>)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    combined <span class="op">=</span> read_powcod_sql()</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(combined.columns)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    combined <span class="op">=</span> combined[[<span class="st">"spacegroup_x"</span>, <span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span>, <span class="st">"alpha"</span>, <span class="st">"beta"</span>,</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"gamma"</span>, <span class="st">"volume"</span>, <span class="st">"h"</span>, <span class="st">"k"</span>, <span class="st">"l"</span>, <span class="st">"nd"</span>, <span class="st">"dvalue"</span>,</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"intensita"</span>, <span class="st">"type"</span>]]</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    combined.to_pickle(<span class="st">"combined.pkl"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s have a look at what we’ve got:</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>combined</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">spacegroup_x</th>
<th data-quarto-table-cell-role="th">a</th>
<th data-quarto-table-cell-role="th">b</th>
<th data-quarto-table-cell-role="th">c</th>
<th data-quarto-table-cell-role="th">alpha</th>
<th data-quarto-table-cell-role="th">beta</th>
<th data-quarto-table-cell-role="th">gamma</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">h</th>
<th data-quarto-table-cell-role="th">k</th>
<th data-quarto-table-cell-role="th">l</th>
<th data-quarto-table-cell-role="th">nd</th>
<th data-quarto-table-cell-role="th">dvalue</th>
<th data-quarto-table-cell-role="th">intensita</th>
<th data-quarto-table-cell-role="th">type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>C m c m</td>
<td>0.0000</td>
<td>0.0000</td>
<td>0.0000</td>
<td>0.0</td>
<td>0.000</td>
<td>0.0</td>
<td>738.078</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0.000000</td>
<td>0.000000</td>
<td>Orthorhombic</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>I 4/m m m</td>
<td>0.0000</td>
<td>0.0000</td>
<td>0.0000</td>
<td>0.0</td>
<td>0.000</td>
<td>0.0</td>
<td>388.473</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0.000000</td>
<td>0.000000</td>
<td>Tetragonal</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>P -1</td>
<td>0.0000</td>
<td>0.0000</td>
<td>0.0000</td>
<td>0.0</td>
<td>0.000</td>
<td>0.0</td>
<td>429.928</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0.000000</td>
<td>0.000000</td>
<td>Triclinic</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>P -3</td>
<td>0.0000</td>
<td>0.0000</td>
<td>0.0000</td>
<td>0.0</td>
<td>0.000</td>
<td>0.0</td>
<td>1221.297</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0.000000</td>
<td>0.000000</td>
<td>Trigonal (hexagonal axes)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>P 1</td>
<td>0.0000</td>
<td>0.0000</td>
<td>0.0000</td>
<td>0.0</td>
<td>0.000</td>
<td>0.0</td>
<td>552.983</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0.000000</td>
<td>0.000000</td>
<td>Cubic</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">458155</td>
<td>P 1 21 1</td>
<td>6.6330</td>
<td>15.4171</td>
<td>11.9417</td>
<td>90.0</td>
<td>103.335</td>
<td>90.0</td>
<td>1188.257</td>
<td>0,0,0,1,0,1,1,1,0,0,1,1,1,1,1,0,1,0,1,1,1,1,1,...</td>
<td>0,1,2,0,2,0,1,1,0,1,0,2,0,1,2,3,1,2,2,2,3,3,0,...</td>
<td>1,1,0,0,1,-1,0,-1,2,2,1,0,-2,1,-1,1,-2,2,1,-2,...</td>
<td>499</td>
<td>11.619700,9.279300,7.708500,6.454200,6.423600,...</td>
<td>1000.000000,62.638200,82.940500,3.929300,0.067...</td>
<td>Monoclinic</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">458156</td>
<td>C 1 2/m 1</td>
<td>21.2287</td>
<td>17.8117</td>
<td>12.3055</td>
<td>90.0</td>
<td>124.759</td>
<td>90.0</td>
<td>3822.662</td>
<td>1,1,0,2,0,2,0,2,1,3,2,2,1,1,3,3,1,2,4,2,0,4,1,...</td>
<td>1,1,0,0,2,0,2,2,1,1,2,0,3,1,1,1,3,0,0,2,0,0,3,...</td>
<td>0,-1,1,-1,0,0,1,-1,1,-1,0,-2,0,-2,0,-2,-1,1,-1...</td>
<td>498</td>
<td>12.461500,10.123800,10.109700,9.999700,8.90580...</td>
<td>1000.000000,1.459300,384.189200,186.432500,88....</td>
<td>Monoclinic</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">458157</td>
<td>C 1 2/m 1</td>
<td>21.5314</td>
<td>18.0366</td>
<td>12.3918</td>
<td>90.0</td>
<td>124.872</td>
<td>90.0</td>
<td>3948.216</td>
<td>1,1,0,2,0,2,0,2,1,3,2,2,1,3,1,3,1,2,4,2,0,4,1,...</td>
<td>1,1,0,0,2,0,2,2,1,1,2,0,3,1,1,1,3,0,0,2,0,0,3,...</td>
<td>0,-1,1,-1,0,0,1,-1,1,-1,0,-2,0,0,-2,-2,-1,1,-1...</td>
<td>498</td>
<td>12.620300,10.213500,10.166600,10.122700,9.0183...</td>
<td>1000.000000,0.425500,401.199700,131.443500,109...</td>
<td>Monoclinic</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">458158</td>
<td>I -4 2 m</td>
<td>10.2400</td>
<td>10.2400</td>
<td>9.6520</td>
<td>90.0</td>
<td>90.000</td>
<td>90.0</td>
<td>1012.086</td>
<td>1,1,2,0,2,1,2,2,3,3,1,2,3,3,2,4,3,0,4,3,4,1,4,...</td>
<td>1,0,0,0,1,1,2,0,1,0,0,2,2,1,1,0,3,0,1,0,2,1,0,...</td>
<td>0,1,0,2,1,2,0,2,0,1,3,2,1,2,3,0,0,4,1,3,0,4,2,...</td>
<td>302</td>
<td>7.240800,7.023700,5.120000,4.826000,4.137400,4...</td>
<td>435.793700,1000.000000,156.773800,74.174400,1....</td>
<td>Tetragonal</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">458159</td>
<td>P n a 21</td>
<td>10.3130</td>
<td>8.1940</td>
<td>4.9930</td>
<td>90.0</td>
<td>90.000</td>
<td>90.0</td>
<td>421.932</td>
<td>1,2,2,0,0,1,1,2,2,2,3,1,2,3,1,3,4,0,4,2,0,1,3,...</td>
<td>1,0,1,1,2,1,2,0,1,2,1,2,2,1,3,2,0,0,1,3,3,3,2,...</td>
<td>0,0,0,1,0,1,0,1,1,0,0,1,1,1,0,0,0,2,0,0,1,1,1,...</td>
<td>484</td>
<td>6.415500,5.156500,4.364200,4.263800,4.097000,3...</td>
<td>884.735400,207.638600,175.487800,594.721200,42...</td>
<td>Orthorhombic</td>
</tr>
</tbody>
</table>

<p>458160 rows × 15 columns</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>combined.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">a</th>
<th data-quarto-table-cell-role="th">b</th>
<th data-quarto-table-cell-role="th">c</th>
<th data-quarto-table-cell-role="th">alpha</th>
<th data-quarto-table-cell-role="th">beta</th>
<th data-quarto-table-cell-role="th">gamma</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">nd</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>458160.000000</td>
<td>458160.000000</td>
<td>458160.000000</td>
<td>458160.000000</td>
<td>458160.000000</td>
<td>458160.000000</td>
<td>458160.000000</td>
<td>458160.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>12.505100</td>
<td>13.372528</td>
<td>16.330272</td>
<td>89.503372</td>
<td>95.199651</td>
<td>90.906179</td>
<td>3178.613746</td>
<td>454.593930</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>6.874009</td>
<td>6.655914</td>
<td>8.092967</td>
<td>8.326557</td>
<td>11.649541</td>
<td>10.924374</td>
<td>6384.755145</td>
<td>119.026662</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>1.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>8.282900</td>
<td>9.153000</td>
<td>11.279975</td>
<td>90.000000</td>
<td>90.000000</td>
<td>90.000000</td>
<td>1089.974000</td>
<td>498.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>10.780000</td>
<td>12.130000</td>
<td>15.169000</td>
<td>90.000000</td>
<td>92.430000</td>
<td>90.000000</td>
<td>1976.458000</td>
<td>499.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>14.703000</td>
<td>16.140000</td>
<td>19.860000</td>
<td>90.000000</td>
<td>101.688000</td>
<td>90.000000</td>
<td>3562.973750</td>
<td>500.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>189.800000</td>
<td>150.000000</td>
<td>475.977800</td>
<td>150.172000</td>
<td>173.895000</td>
<td>149.900000</td>
<td>740478.188000</td>
<td>500.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">4</span>, figsize<span class="op">=</span>(<span class="dv">18</span>,<span class="dv">7</span>))</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(combined.a, ax<span class="op">=</span>ax[<span class="dv">0</span>][<span class="dv">0</span>])</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(combined.b, ax<span class="op">=</span>ax[<span class="dv">0</span>][<span class="dv">1</span>])</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(combined.c, ax<span class="op">=</span>ax[<span class="dv">0</span>][<span class="dv">2</span>])</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(combined.volume, ax<span class="op">=</span>ax[<span class="dv">0</span>][<span class="dv">3</span>])</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(combined.alpha, ax<span class="op">=</span>ax[<span class="dv">1</span>][<span class="dv">0</span>])</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(combined.beta, ax<span class="op">=</span>ax[<span class="dv">1</span>][<span class="dv">1</span>])</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(combined.gamma, ax<span class="op">=</span>ax[<span class="dv">1</span>][<span class="dv">2</span>])</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(combined.nd, ax<span class="op">=</span>ax[<span class="dv">1</span>][<span class="dv">3</span>])</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-09-01-Training-neural-networks-on-PXRD-data_files/figure-html/cell-6-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>We’re starting off with 458k samples, but a lot of these won’t be useful for our model. I’m going to focus on typical small molecule crystal structures, and attempt to generate realistic looking laboratory diffraction data.</p>
<p>From the snippets of the data we can above, it’s clear that some unit cells are listed as having zero volume, with 0 for the cell lengths and angles. These are not useful to us, so we’ll need to remove them. We can also see that there are some monstrous unit cells in there! To make things manageable, we’re going to restrict our data to having reasonable unit cell dimensions and volumes. Let’s set the lower and upper limits for volume to 400 and 4000 cubic angstroms respectively, and set the maximum unit cell length to 50 angstroms. We can also see some unusual looking unit cell angles, so I’m going to trim entries with cell angles below 60 and above 120 degrees.</p>
<p>Eventually, we’re going to generate diffraction data in the range (arbirarily chosen!) 4 - 44 degrees <span class="math inline">\(2\theta\)</span> with Cu Ka1 radiation. We’ll want to ensure that there are at least a few easily detectable peaks within this chosen range. I’ll set the lower bound for this as 10.</p>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>min_volume <span class="op">=</span> <span class="dv">400</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>max_volume <span class="op">=</span> <span class="dv">4000</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>max_cell_length <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>min_cell_angle <span class="op">=</span> <span class="dv">60</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>max_cell_angle <span class="op">=</span> <span class="dv">120</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>min_data_angle <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>max_data_angle <span class="op">=</span> <span class="dv">44</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>wavelength <span class="op">=</span> <span class="fl">1.54056</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>min_detectable_peaks_in_range <span class="op">=</span> <span class="dv">10</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s first filter by the unit cell restrictions on volume, lengths and angles. We can also filter by the number of d-spacings (in the column <code>nd</code>) though we will need to come back to this again later to check that the remaining reflections are both in the range desired and also have reasonable intensities.</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>combined <span class="op">=</span> combined[(combined.volume <span class="op">&lt;=</span> max_volume) <span class="op">&amp;</span> (combined.volume <span class="op">&gt;=</span> min_volume)]</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>combined <span class="op">=</span> combined[(combined.a <span class="op">!=</span> <span class="dv">0</span>) <span class="op">&amp;</span> (combined.b <span class="op">!=</span> <span class="dv">0</span>) <span class="op">&amp;</span> (combined.c <span class="op">!=</span> <span class="dv">0</span>)]</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>combined <span class="op">=</span> combined[(combined.a <span class="op">&lt;=</span> max_cell_length) <span class="op">&amp;</span> (combined.b <span class="op">&lt;=</span> max_cell_length) <span class="op">&amp;</span> (combined.c <span class="op">&lt;=</span> max_cell_length)]</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>combined <span class="op">=</span> combined[(combined.alpha <span class="op">&gt;=</span> min_cell_angle) <span class="op">&amp;</span> (combined.alpha <span class="op">&lt;=</span> max_cell_angle)]</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>combined <span class="op">=</span> combined[(combined.beta <span class="op">&gt;=</span> min_cell_angle) <span class="op">&amp;</span> (combined.beta <span class="op">&lt;=</span> max_cell_angle)]</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>combined <span class="op">=</span> combined[(combined.gamma <span class="op">&gt;=</span> min_cell_angle) <span class="op">&amp;</span> (combined.gamma <span class="op">&lt;=</span> max_cell_angle)]</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>combined <span class="op">=</span> combined[(combined.nd <span class="op">&gt;=</span> n_detectable_peaks_in_range)]</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>combined.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">a</th>
<th data-quarto-table-cell-role="th">b</th>
<th data-quarto-table-cell-role="th">c</th>
<th data-quarto-table-cell-role="th">alpha</th>
<th data-quarto-table-cell-role="th">beta</th>
<th data-quarto-table-cell-role="th">gamma</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">nd</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>324333.000000</td>
<td>324333.000000</td>
<td>324333.000000</td>
<td>324333.000000</td>
<td>324333.000000</td>
<td>324333.000000</td>
<td>324333.000000</td>
<td>324333.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>10.992746</td>
<td>12.400612</td>
<td>15.034673</td>
<td>89.719327</td>
<td>94.956107</td>
<td>90.499324</td>
<td>1849.638022</td>
<td>477.448866</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>4.372923</td>
<td>4.840500</td>
<td>5.626536</td>
<td>7.474114</td>
<td>9.913211</td>
<td>9.476333</td>
<td>931.743127</td>
<td>81.543710</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>2.808500</td>
<td>2.820000</td>
<td>2.718100</td>
<td>60.019000</td>
<td>60.130000</td>
<td>60.000000</td>
<td>400.059000</td>
<td>16.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>8.236400</td>
<td>9.237500</td>
<td>11.247500</td>
<td>90.000000</td>
<td>90.000000</td>
<td>90.000000</td>
<td>1085.857000</td>
<td>498.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>10.114500</td>
<td>11.585500</td>
<td>14.365300</td>
<td>90.000000</td>
<td>93.216000</td>
<td>90.000000</td>
<td>1699.288000</td>
<td>499.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>12.609000</td>
<td>14.506900</td>
<td>17.908600</td>
<td>90.000000</td>
<td>101.601000</td>
<td>90.000000</td>
<td>2515.215000</td>
<td>500.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>49.953000</td>
<td>49.977000</td>
<td>49.944000</td>
<td>119.990000</td>
<td>120.000000</td>
<td>120.000000</td>
<td>3999.991000</td>
<td>500.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>That’s a fairly significant reduction in the number of samples, down by over 100k! However, hopefully we’ve gotten rid of most of the really odd or unusable samples in the dataset.</p>
<p>Let’s now replot the kernel density plots we saw earlier and see if things look a bit nicer.</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">4</span>, figsize<span class="op">=</span>(<span class="dv">18</span>,<span class="dv">7</span>))</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(combined.a, ax<span class="op">=</span>ax[<span class="dv">0</span>][<span class="dv">0</span>])</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(combined.b, ax<span class="op">=</span>ax[<span class="dv">0</span>][<span class="dv">1</span>])</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(combined.c, ax<span class="op">=</span>ax[<span class="dv">0</span>][<span class="dv">2</span>])</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(combined.volume, ax<span class="op">=</span>ax[<span class="dv">0</span>][<span class="dv">3</span>])</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(combined.alpha, ax<span class="op">=</span>ax[<span class="dv">1</span>][<span class="dv">0</span>])</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(combined.beta, ax<span class="op">=</span>ax[<span class="dv">1</span>][<span class="dv">1</span>])</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(combined.gamma, ax<span class="op">=</span>ax[<span class="dv">1</span>][<span class="dv">2</span>])</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(combined.nd, ax<span class="op">=</span>ax[<span class="dv">1</span>][<span class="dv">3</span>])</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2023-09-01-Training-neural-networks-on-PXRD-data_files/figure-html/cell-9-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Things look a bit nicer now! Just out of interest, we’ll take a quick look at the distribution of crystal systems and space groups. Other work looking at the CSD and other databases has shown a significant imbalance in the number of crystal structures adopting each crystal system and indeed space group.</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>combined.<span class="bu">type</span>.value_counts().sort_values().iloc[::<span class="op">-</span><span class="dv">1</span>].head(<span class="dv">20</span>).plot.bar()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>&lt;Axes: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-09-01-Training-neural-networks-on-PXRD-data_files/figure-html/cell-10-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>combined.spacegroup_x.value_counts().sort_values().iloc[::<span class="op">-</span><span class="dv">1</span>].head(<span class="dv">20</span>).plot.bar()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>&lt;Axes: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2023-09-01-Training-neural-networks-on-PXRD-data_files/figure-html/cell-11-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Unsurprisingly, much like has been observed in both the CSD and ICDD datasets, we again see that some space groups are much more frequently observed than others. In this project, we aren’t doing crystal system, space group or extinction symbol classification, but if we come back to that in the future, we would need to keep this fairly severe class imbalance in mind!</p>
<p>We can now turn our attention to the diffraction data - the Miller indices and d-spacings. Some of these entries will have a huge number of peaks, some will have very few. Ideally, we want to ensure that within our chosen data range, we have a reasonable number of peaks. We also want to ensure that there are still a few peaks <em>outside</em> the top end of our data range, meaning that we aren’t missing any data inside our range. Each entry has up to 500 d-spacings calculated. With the chosen data range of 4 to 44 degrees, (assU_ming that the radiation source is copper Ka1), we will ensure that none of the peaks are below 4 degrees, and there is at least one peak above 44 degrees.</p>
<p>Our dataframe contains the d-spacings for the observed reflections, so using Bragg’s law we can easily convert the angular requirements into d-spacings.</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>d_from_tt <span class="op">=</span> <span class="kw">lambda</span> x: wavelength<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>np.sin(np.deg2rad(x)<span class="op">/</span><span class="dv">2</span>))</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>tt_from_d <span class="op">=</span> <span class="kw">lambda</span> x: <span class="dv">2</span><span class="op">*</span>np.rad2deg(np.arcsin(wavelength<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>x)))</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>max_d <span class="op">=</span> d_from_tt(min_data_angle)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>min_d <span class="op">=</span> d_from_tt(max_data_angle)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Minimum angle = </span><span class="sc">{</span>min_data_angle<span class="sc">}</span><span class="ss">  : Maximum d-spacing = </span><span class="sc">{</span>max_d<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Maximum angle = </span><span class="sc">{</span>max_data_angle<span class="sc">}</span><span class="ss"> : Minimum d-spacing = </span><span class="sc">{</span>min_d<span class="sc">:.3f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Minimum angle = 4  : Maximum d-spacing = 22.071
Maximum angle = 44 : Minimum d-spacing = 2.056</code></pre>
</div>
</div>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> keepdata(x):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> <span class="bu">list</span>(<span class="bu">filter</span>(<span class="va">None</span>, x.strip().split(<span class="st">","</span>)))</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> [<span class="bu">float</span>(i) <span class="cf">for</span> i <span class="kw">in</span> d]</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(d) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> d[<span class="op">-</span><span class="dv">1</span>] <span class="op">&gt;</span> min_d:</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> d[<span class="dv">0</span>] <span class="op">&gt;</span> max_d:</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>combined[<span class="st">"keepdata"</span>] <span class="op">=</span> combined.dvalue.<span class="bu">apply</span>(keepdata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>combined <span class="op">=</span> combined[combined[<span class="st">"keepdata"</span>] <span class="op">==</span> <span class="va">True</span>]</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>combined.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">a</th>
<th data-quarto-table-cell-role="th">b</th>
<th data-quarto-table-cell-role="th">c</th>
<th data-quarto-table-cell-role="th">alpha</th>
<th data-quarto-table-cell-role="th">beta</th>
<th data-quarto-table-cell-role="th">gamma</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">nd</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>294683.000000</td>
<td>294683.000000</td>
<td>294683.000000</td>
<td>294683.000000</td>
<td>294683.000000</td>
<td>294683.000000</td>
<td>294683.000000</td>
<td>294683.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>10.882315</td>
<td>12.252111</td>
<td>14.657953</td>
<td>89.811073</td>
<td>95.485959</td>
<td>90.696809</td>
<td>1761.150442</td>
<td>475.402500</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>4.412962</td>
<td>4.931853</td>
<td>5.573568</td>
<td>6.728590</td>
<td>9.625816</td>
<td>8.862066</td>
<td>911.736827</td>
<td>85.123379</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>2.808500</td>
<td>2.825500</td>
<td>2.718100</td>
<td>60.019000</td>
<td>60.130000</td>
<td>60.000000</td>
<td>400.059000</td>
<td>16.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>8.102900</td>
<td>9.061000</td>
<td>10.947350</td>
<td>90.000000</td>
<td>90.000000</td>
<td>90.000000</td>
<td>1033.393500</td>
<td>498.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>9.901200</td>
<td>11.254000</td>
<td>13.872700</td>
<td>90.000000</td>
<td>93.575000</td>
<td>90.000000</td>
<td>1587.357000</td>
<td>499.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>12.471000</td>
<td>14.242100</td>
<td>17.398800</td>
<td>90.000000</td>
<td>101.978000</td>
<td>90.000000</td>
<td>2355.104000</td>
<td>500.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>45.366000</td>
<td>48.809000</td>
<td>49.494500</td>
<td>119.990000</td>
<td>120.000000</td>
<td>120.000000</td>
<td>3999.991000</td>
<td>500.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We are down to just shy of 300k samples now.</p>
<p>Lastly, let’s ensure that we have sufficient easily detectable peaks within our data range. Do to this, we need to look at the intensities:</p>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>combined.intensita</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>11        1000.000000,293.781700,0.932900,880.099700,350...
12        344.517500,136.663800,113.543400,41.743900,4.9...
13        480.841100,1000.000000,345.837700,13.887000,72...
14        6.550100,7.094000,99.801200,1000.000000,642.20...
17        2.707700,223.647400,1000.000000,119.345700,113...
                                ...                        
458148    191.292600,19.724900,41.216500,169.019100,150....
458151    1000.000000,782.379000,202.061600,29.027900,13...
458155    1000.000000,62.638200,82.940500,3.929300,0.067...
458158    435.793700,1000.000000,156.773800,74.174400,1....
458159    884.735400,207.638600,175.487800,594.721200,42...
Name: intensita, Length: 294683, dtype: object</code></pre>
</div>
</div>
<p>Intensities are all scaled to a maximum of 1000. We should ensure that in our chosen data range, the intensities that are present are actually strong enough to be observed! Let’s say we want the minimum intensity in our data range to be 0.5 % of the maximum intensity. As such, we should have at least 10 intensities in our range with a value greater than 5.</p>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_peaks_in_range(dspacing, intensity, min_intensity<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    dspacing <span class="op">=</span> <span class="bu">list</span>(<span class="bu">filter</span>(<span class="va">None</span>, dspacing.strip().split(<span class="st">","</span>)))</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    dspacing <span class="op">=</span> np.array([<span class="bu">float</span>(i) <span class="cf">for</span> i <span class="kw">in</span> dspacing])</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    intensity <span class="op">=</span> <span class="bu">list</span>(<span class="bu">filter</span>(<span class="va">None</span>, intensity.strip().split(<span class="st">","</span>)))</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    intensity <span class="op">=</span> np.array([<span class="bu">float</span>(i) <span class="cf">for</span> i <span class="kw">in</span> intensity])</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    intensity <span class="op">=</span> intensity[dspacing <span class="op">&gt;=</span> min_d]</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (intensity <span class="op">&gt;</span> min_intensity).<span class="bu">sum</span>()</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>combined[<span class="st">"n_detectable_peaks_in_range"</span>] <span class="op">=</span> combined.<span class="bu">apply</span>(<span class="kw">lambda</span> x: n_peaks_in_range(x.dvalue, x.intensita), axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>combined <span class="op">=</span> combined[combined.n_detectable_peaks_in_range <span class="op">&gt;=</span> min_detectable_peaks_in_range]</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>combined.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">a</th>
<th data-quarto-table-cell-role="th">b</th>
<th data-quarto-table-cell-role="th">c</th>
<th data-quarto-table-cell-role="th">alpha</th>
<th data-quarto-table-cell-role="th">beta</th>
<th data-quarto-table-cell-role="th">gamma</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">nd</th>
<th data-quarto-table-cell-role="th">n_detectable_peaks_in_range</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>288749.000000</td>
<td>288749.000000</td>
<td>288749.000000</td>
<td>288749.000000</td>
<td>288749.000000</td>
<td>288749.000000</td>
<td>288749.000000</td>
<td>288749.000000</td>
<td>288749.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>10.917842</td>
<td>12.315544</td>
<td>14.766404</td>
<td>89.807191</td>
<td>95.598556</td>
<td>90.697573</td>
<td>1780.395031</td>
<td>484.018237</td>
<td>115.539832</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>4.445510</td>
<td>4.956467</td>
<td>5.569416</td>
<td>6.797322</td>
<td>9.691691</td>
<td>8.930478</td>
<td>909.196809</td>
<td>60.547184</td>
<td>57.885137</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>2.808500</td>
<td>2.825500</td>
<td>2.760000</td>
<td>60.019000</td>
<td>60.130000</td>
<td>60.000000</td>
<td>400.059000</td>
<td>30.000000</td>
<td>10.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>8.097000</td>
<td>9.133100</td>
<td>11.118900</td>
<td>90.000000</td>
<td>90.000000</td>
<td>90.000000</td>
<td>1054.117000</td>
<td>498.000000</td>
<td>74.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>9.925400</td>
<td>11.334000</td>
<td>13.981500</td>
<td>90.000000</td>
<td>93.894000</td>
<td>90.000000</td>
<td>1608.456000</td>
<td>499.000000</td>
<td>108.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>12.546000</td>
<td>14.339000</td>
<td>17.489900</td>
<td>90.000000</td>
<td>102.168000</td>
<td>90.000000</td>
<td>2379.104000</td>
<td>500.000000</td>
<td>150.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>45.366000</td>
<td>48.809000</td>
<td>49.494500</td>
<td>119.990000</td>
<td>120.000000</td>
<td>120.000000</td>
<td>3999.991000</td>
<td>500.000000</td>
<td>386.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Now that we’ve filtered our data to our requirements, the last thing I’m going to do is save the relevant information in numpy arrays which I can then quickly and easily load from disk for future work.</p>
<p>I’ll save a few different arrays: - Unit cells - Crystal system - Miller indices - Peak intensities</p>
<p>As the number of peaks in each pattern is different, the Miller indices and Peak intensity arrays will need padding up to the maximum number, which is 500. First we’ll save the unit cells and crystal systems. I’m going to convert the strings for the crystal systems into integers using <code>np.unique</code>, and we can save the keys for use later on.</p>
<div class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>unit_cell <span class="op">=</span> combined[[<span class="st">"a"</span>,<span class="st">"b"</span>,<span class="st">"c"</span>,<span class="st">"alpha"</span>,<span class="st">"beta"</span>,<span class="st">"gamma"</span>]].to_numpy()</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>crystal_systems, crystal_systems_numeric <span class="op">=</span> np.unique(combined.<span class="bu">type</span>.to_numpy(), return_inverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(crystal_systems)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['Cubic' 'Hexagonal' 'Monoclinic' 'Orthorhombic' 'Tetragonal' 'Triclinic'
 'Trigonal (hexagonal axes)' 'Trigonal (rhombohedral axes)']</code></pre>
</div>
</div>
<p>Now we’ll deal with the Miller indices and intensities. A simple function can be used to convert the strings (as in the database) into arrays and pad them with zeros where needed. We then stack the output into our numpy arrays.</p>
<div class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_array(x, dtype<span class="op">=</span>np.float32):</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    zeros <span class="op">=</span> np.zeros(<span class="dv">500</span>, dtype<span class="op">=</span>dtype)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="bu">list</span>(<span class="bu">filter</span>(<span class="va">None</span>, x.strip().split(<span class="st">","</span>)))</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.array(x, dtype<span class="op">=</span>dtype)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    zeros[:<span class="bu">len</span>(x)] <span class="op">=</span> x</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> zeros</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>h <span class="op">=</span> combined.h.<span class="bu">apply</span>(get_array, args<span class="op">=</span>(np.int64,))</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> combined.k.<span class="bu">apply</span>(get_array, args<span class="op">=</span>(np.int64,))</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>l <span class="op">=</span> combined.l.<span class="bu">apply</span>(get_array, args<span class="op">=</span>(np.int64,))</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>intensities <span class="op">=</span> combined.intensita.<span class="bu">apply</span>(get_array, args<span class="op">=</span>(np.float32,))</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>intensities <span class="op">=</span> np.vstack(intensities)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>h <span class="op">=</span> np.vstack(h)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> np.vstack(k)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>l <span class="op">=</span> np.vstack(l)</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>hkl <span class="op">=</span> np.dstack([h,k,l])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can save everything, as well as a file to keep track of our data configuration settings, which we’ll save using the <code>json</code> format.</p>
<div class="cell" data-execution_count="109">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>base_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>min_data_angle<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>max_data_angle<span class="sc">}</span><span class="ss">-CuKa1-data_</span><span class="sc">{</span>max_volume<span class="sc">}</span><span class="ss">_"</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> {}</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>config[<span class="st">"base_name"</span>] <span class="op">=</span> base_name</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>config[<span class="st">"min_volume"</span>] <span class="op">=</span> min_volume</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>config[<span class="st">"max_volume"</span>] <span class="op">=</span> max_volume</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>config[<span class="st">"max_cell_length"</span>] <span class="op">=</span> max_cell_length</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>config[<span class="st">"min_cell_angle"</span>] <span class="op">=</span> min_cell_angle</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>config[<span class="st">"max_cell_angle"</span>] <span class="op">=</span> max_cell_angle</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>config[<span class="st">"min_data_angle"</span>] <span class="op">=</span> min_data_angle</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>config[<span class="st">"max_data_angle"</span>] <span class="op">=</span> max_data_angle</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>config[<span class="st">"wavelength"</span>] <span class="op">=</span> wavelength</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>config[<span class="st">"min_detectable_peaks_in_range"</span>] <span class="op">=</span> min_detectable_peaks_in_range</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>config[<span class="st">"crystal_systems"</span>] <span class="op">=</span> [x[<span class="dv">0</span>]<span class="op">+</span><span class="st">" = "</span><span class="op">+</span><span class="bu">str</span>(x[<span class="dv">1</span>]) <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">zip</span>(crystal_systems, np.arange(<span class="bu">len</span>(crystal_systems)))]</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(base_name<span class="op">+</span><span class="st">"data_config.json"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    json.dump(config, f, indent<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>np.save(base_name<span class="op">+</span><span class="st">"unit_cell.npy"</span>, unit_cell)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>np.save(base_name<span class="op">+</span><span class="st">"crystal_systems_numeric.npy"</span>, crystal_systems_numeric)</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>np.save(base_name<span class="op">+</span><span class="st">"hkl.npy"</span>, hkl)</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>np.save(base_name<span class="op">+</span><span class="st">"intensities.npy"</span>, intensities)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="loading-data" class="level2">
<h2 class="anchored" data-anchor-id="loading-data">Loading data</h2>
<p>Now that we have our numpy arrays saved to disk, we need a way to load our diffraction data before feeding it into the functions described below. The framework I’ll be using for neural network training is PyTorch, so we need to get our data from disk into pytorch tensors.</p>
<p>Given the size of the dataset we’re using (~3.8 GB), we can load it all into memory. If working with limited RAM, however, we’d need a helper function to load from disk into memory. Numpy has a very convenient <a href="https://numpy.org/doc/stable/reference/generated/numpy.load.html">memory-mapped load method</a> for the .npy files we saved earlier but in this case, it’s probably not needed.</p>
<div class="cell" data-execution_count="153">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">"4-44-CuKa1-data_4000_data_config.json"</span>, <span class="st">"r"</span>) <span class="im">as</span> f:</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> json.load(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>At this point, it’s a good idea for us to split the data into training, validation, and test sets. We’ll use a 75/15/10 split. To do that, we’ll use a pytorch Dataset, and then apply a random split to get the different sets. To ensure this is consistent between runs on the data, we’ll manually set the random seed.</p>
<div class="cell" data-execution_count="264">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DiffractionData(Dataset):</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,base_name, root_dir<span class="op">=</span><span class="st">"./"</span>):</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.crystal_system_numeric <span class="op">=</span> torch.tensor(np.load(root_dir<span class="op">+</span>base_name<span class="op">+</span><span class="st">"crystal_systems_numeric.npy"</span>))</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.hkl                    <span class="op">=</span> torch.tensor(np.load(root_dir<span class="op">+</span>base_name<span class="op">+</span><span class="st">"hkl.npy"</span>)).<span class="bu">float</span>()</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.intensities            <span class="op">=</span> torch.tensor(np.load(root_dir<span class="op">+</span>base_name<span class="op">+</span><span class="st">"intensities.npy"</span>)).<span class="bu">float</span>()</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.unit_cell              <span class="op">=</span> torch.tensor(np.load(root_dir<span class="op">+</span>base_name<span class="op">+</span><span class="st">"unit_cell.npy"</span>)).<span class="bu">float</span>()</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.intensities)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx):</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.crystal_system_numeric[idx], <span class="va">self</span>.hkl[idx], <span class="va">self</span>.intensities[idx], <span class="va">self</span>.unit_cell[idx]</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> DiffractionData(config[<span class="st">"base_name"</span>])</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>train_set, val_set, test_set <span class="op">=</span> torch.utils.data.random_split(dataset, [<span class="fl">0.75</span>, <span class="fl">0.15</span>, <span class="fl">0.1</span>], torch.Generator().manual_seed(<span class="dv">42</span>))</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Training samples : </span><span class="sc">{</span><span class="bu">len</span>(train_set)<span class="sc">}</span><span class="ch">\n</span><span class="ss">Validation samples : </span><span class="sc">{</span><span class="bu">len</span>(val_set)<span class="sc">}</span><span class="ch">\n</span><span class="ss">Test samples : </span><span class="sc">{</span><span class="bu">len</span>(test_set)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Training samples : 216562
Validation samples : 43313
Test samples : 28874</code></pre>
</div>
</div>
</section>
<section id="peak-positions" class="level2">
<h2 class="anchored" data-anchor-id="peak-positions">Peak positions</h2>
<p>Now that we’ve filtered down the original PowCod database into the entries that meet the (arbitrary) conditions described earlier, it’s time to start thinking about how we can use the information to generate synthetic PXRD data.</p>
<p>Rather than using the d-spacings from the database directly, we are going to make use of the unit cells and Miller indices to calculate the d-spacings (and hence angles) for the reflections. This will allow us to add a small amount of noise to the unit cell dimensions, which serves as a form of data augmentation.</p>
<p>The d-spacing of a peak can be calculated using this equation:</p>
<p><span class="math display">\[
NEED TO WRITE THE EQUATION HERE!
\]</span></p>
<p>where …</p>
<p>So, we will need a function to convert the unit cell dimensions into the matrix representation of the unit cell, then invert this before using the reciprocal lattice matrix to determine the reciprocal lattice metric tensor. Once we have the reciprocal lattice metric tensor, we can calculate the d-spacings quite easily by multiplying with the Miller index array(s).</p>
<p>To simulate the effect of temperature changes, we’ll add a small amount of Gaussian noise to the unit cell dimensions. We will have to consider the crystal system symmetry here in order to ensure that, for example a cubic unit cell, the perturbation to lengths <span class="math inline">\(b\)</span> and <span class="math inline">\(c\)</span> is equal to the pertubation to <span class="math inline">\(a\)</span>.</p>
<p>I’ll be fairly conservative about how much the dimensions get perturbed, and set the standard deviation of the random noise to 0.05, meaning that the majority of perturbed unit cells should have edges with lengths +/- 0.15 angstroms from the database values, and angles +/- 0.15 degrees (assU_ming they are allowed to very by symmetry). This seems reasonable, and should allow us to assume that the fractional coordinates within the unit cells are unaffected, so we don’t need to worry about the effect on the relative intensities.</p>
<div class="cell" data-execution_count="175">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_unit_cell_perturbation(crystal_systems, dtype<span class="op">=</span>torch.float32, stddev<span class="op">=</span><span class="fl">0.05</span>):</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    batchsize <span class="op">=</span> crystal_systems.shape[<span class="dv">0</span>]</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    device <span class="op">=</span> crystal_systems.device</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    lengths, angles <span class="op">=</span> torch.randn((<span class="dv">2</span>, batchsize, <span class="dv">3</span>), device<span class="op">=</span>device, dtype<span class="op">=</span>dtype) <span class="op">*</span> stddev</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    cubic <span class="op">=</span> crystal_systems <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    hexagonal <span class="op">=</span> crystal_systems <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    monoclinic <span class="op">=</span> crystal_systems <span class="op">==</span> <span class="dv">2</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#orthorhombic = crystal_systems == 3 # Don't need to query data for this</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    tetragonal <span class="op">=</span> crystal_systems <span class="op">==</span> <span class="dv">4</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    triclinic <span class="op">=</span> crystal_systems <span class="op">==</span> <span class="dv">5</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    trigonal_h <span class="op">=</span> crystal_systems <span class="op">==</span> <span class="dv">6</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    trigonal_r <span class="op">=</span> crystal_systems <span class="op">==</span> <span class="dv">7</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cubic, tetragonal, rhombohedral and hexagonal - a and b must be the same</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    lengths[:,<span class="dv">1</span>] <span class="op">=</span> torch.where(cubic <span class="op">|</span> hexagonal <span class="op">|</span> tetragonal <span class="op">|</span> trigonal_h <span class="op">|</span> trigonal_r,</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>                            lengths[:,<span class="dv">0</span>], lengths[:,<span class="dv">1</span>])</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cubic and rhombohedral cells - a, b and c must be the same</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    lengths[:,<span class="dv">2</span>] <span class="op">=</span> torch.where(cubic <span class="op">|</span> trigonal_r, lengths[:,<span class="dv">0</span>], lengths[:,<span class="dv">2</span>])</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rhombohedral and triclinic cells - could change their alpha values</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    angles[:,<span class="dv">0</span>] <span class="op">=</span> torch.where((trigonal_r <span class="op">|</span> triclinic), angles[:,<span class="dv">0</span>], <span class="fl">0.</span>)</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Triclinic or monoclinic cells could change beta values</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    angles[:,<span class="dv">1</span>] <span class="op">=</span> torch.where((triclinic <span class="op">|</span> monoclinic), angles[:,<span class="dv">1</span>], <span class="fl">0.</span>)</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Triclinc cells could change gamma</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    angles[:,<span class="dv">2</span>] <span class="op">=</span> torch.where(triclinic, angles[:,<span class="dv">2</span>], <span class="fl">0.</span>)</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rhombohedral cells - need to ensure all angles are the same</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    angles[:,<span class="dv">1</span>] <span class="op">=</span> torch.where(trigonal_r, angles[:,<span class="dv">0</span>], angles[:,<span class="dv">1</span>])</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>    angles[:,<span class="dv">2</span>] <span class="op">=</span> torch.where(trigonal_r, angles[:,<span class="dv">0</span>], angles[:,<span class="dv">2</span>])</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> lengths, angles</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s check it does what it’s meant to!</p>
<p>What we’re expecting is that for the unit cell lengths, the perturbation should be the same for each of the edges for cubic and rhombohedral cells, and the perturbation for <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> should be the same for hexagonal and tetragonal cells.</p>
<p>With regards to angles, where the original unit cell is an angle of 90 or 120 degrees, the perturbation should be zero. So we should see a change in the beta value for monoclinic cells, a change for all values of the triclinic unit cells and the same change for each of the angles for rhombohedral cells.</p>
<div class="cell" data-execution_count="186">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> config[<span class="st">"crystal_systems"</span>]:</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    name, number <span class="op">=</span> c.split(<span class="st">" = "</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    lengths, angles <span class="op">=</span> get_unit_cell_perturbation(torch.tensor([<span class="bu">int</span>(number)]))</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(name, <span class="st">"Length perturbation:"</span>, lengths)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(name, <span class="st">"Angle perturbation"</span>, angles,<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cubic Length perturbation: tensor([[0.0211, 0.0211, 0.0211]])
Cubic Angle perturbation tensor([[0., 0., 0.]]) 

Hexagonal Length perturbation: tensor([[-0.0229, -0.0229,  0.0531]])
Hexagonal Angle perturbation tensor([[0., 0., 0.]]) 

Monoclinic Length perturbation: tensor([[-0.1008,  0.0537, -0.0333]])
Monoclinic Angle perturbation tensor([[0.0000, 0.0365, 0.0000]]) 

Orthorhombic Length perturbation: tensor([[ 0.0158,  0.0068, -0.0314]])
Orthorhombic Angle perturbation tensor([[0., 0., 0.]]) 

Tetragonal Length perturbation: tensor([[0.0366, 0.0366, 0.0669]])
Tetragonal Angle perturbation tensor([[0., 0., 0.]]) 

Triclinic Length perturbation: tensor([[ 0.0249, -0.0221,  0.0535]])
Triclinic Angle perturbation tensor([[-0.0636, -0.0724, -0.1099]]) 

Trigonal (hexagonal axes) Length perturbation: tensor([[0.0048, 0.0048, 0.0696]])
Trigonal (hexagonal axes) Angle perturbation tensor([[0., 0., 0.]]) 

Trigonal (rhombohedral axes) Length perturbation: tensor([[-0.0257, -0.0257, -0.0257]])
Trigonal (rhombohedral axes) Angle perturbation tensor([[0.0986, 0.0986, 0.0986]]) 
</code></pre>
</div>
</div>
<p>Looks good to me. We now need to start writing functions to generate our lattice matrix, reciprocal lattice matrix and reciprocal lattice metric tensor. We can then use these in conjunction with the Miller indices to determine the reflection d-spacings.</p>
<p>One other thing we should during this process is to check that the perturbed unit cells actually give valid unit cells. We can do that by calculating the volume of the unit cells - if the value is &gt; 0 then the unit cell is valid, otherwise, the set of lengths and angles do not construct a valid parallelipiped.</p>
<div class="cell" data-execution_count="199">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_lattice_matrix(unit_cell_dimensions):</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    pi_over_180<span class="op">=</span><span class="fl">0.017453292519943295</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    a, b, c <span class="op">=</span> unit_cell_dimensions[:,:<span class="dv">3</span>].T</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    cosal, cosbe, cosga <span class="op">=</span> torch.cos(unit_cell_dimensions[:,<span class="dv">3</span>:]<span class="op">*</span>pi_over_180).T</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    sinal, sinbe <span class="op">=</span> torch.sin(unit_cell_dimensions[:,<span class="dv">3</span>:<span class="op">-</span><span class="dv">1</span>]<span class="op">*</span>pi_over_180).T</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sometimes rounding errors cause |values| slightly &gt; 1.</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    val <span class="op">=</span> torch.clamp((cosal <span class="op">*</span> cosbe <span class="op">-</span> cosga) <span class="op">/</span> (sinal <span class="op">*</span> sinbe), <span class="bu">min</span><span class="op">=-</span><span class="dv">1</span>, <span class="bu">max</span><span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    gamma_star <span class="op">=</span> torch.arccos(val)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    zeros <span class="op">=</span> torch.zeros_like(c)</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    v_a <span class="op">=</span> torch.stack([a <span class="op">*</span> sinbe, zeros, a<span class="op">*</span>cosbe]).T</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    v_b <span class="op">=</span> torch.stack([<span class="op">-</span>b <span class="op">*</span> sinal <span class="op">*</span> torch.cos(gamma_star),</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>                    b<span class="op">*</span>sinal <span class="op">*</span> torch.sin(gamma_star),</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>                    b<span class="op">*</span>cosal]).T</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    v_c <span class="op">=</span> torch.stack([zeros, zeros, c]).T</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    matrix <span class="op">=</span> torch.stack([v_a,v_b,v_c], dim<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Unit cells are valid if cell volume &gt; 0</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The cell volume is |det(M)|, but don't need the absolute value here</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    volume <span class="op">=</span> torch.linalg.det(matrix)</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    valid <span class="op">=</span> volume <span class="op">!=</span> <span class="dv">0</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> matrix, valid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Again, let’s quickly check that this works as expected. I’ll give it a simple cubic unit cell, and an invalid unit cell.</p>
<div class="cell" data-execution_count="265">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>cubic_cell <span class="op">=</span> torch.tensor([<span class="fl">5.0</span>,<span class="fl">5.0</span>,<span class="fl">5.0</span>,<span class="fl">90.0</span>,<span class="fl">90.0</span>,<span class="fl">90.0</span>]).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>invalid_cell <span class="op">=</span> torch.tensor([<span class="fl">5.0</span>,<span class="fl">6.0</span>,<span class="fl">7.0</span>,<span class="fl">120.0</span>,<span class="fl">120.0</span>,<span class="fl">120.0</span>]).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Cubic cell valid -"</span>,get_lattice_matrix(cubic_cell)[<span class="dv">1</span>].item())</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Invalid cell valid -"</span>, get_lattice_matrix(invalid_cell)[<span class="dv">1</span>].item())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cubic cell valid - True
Invalid cell valid - False</code></pre>
</div>
</div>
<p>I’ll add the other functions, then a little wrapper to combine them, which will allow us to feed in unit cells and Miller indices, and get back peak positions.</p>
<div class="cell" data-execution_count="266">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_recip_lattice_metric_tensor(recip_lattice_matrix):</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> recip_lattice_matrix <span class="op">@</span> recip_lattice_matrix.permute(<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">1</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_d_spacing(recip_latt_metric_tensor,hkl):</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    one_over_d_squared <span class="op">=</span> torch.einsum(<span class="st">"bij,bji-&gt;bi"</span>,hkl,torch.einsum(</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"bij,bkj-&gt;bik"</span>,recip_latt_metric_tensor,hkl))</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> <span class="dv">1</span><span class="op">/</span>torch.sqrt(one_over_d_squared)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> d</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> d_to_tt(d,wavelength):</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    two_times_180_over_pi <span class="op">=</span> <span class="fl">114.59155902616465</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    tt <span class="op">=</span> two_times_180_over_pi<span class="op">*</span>torch.arcsin(wavelength<span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>d))</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tt</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_peak_positions(unit_cells, hkl, wavelength<span class="op">=</span><span class="fl">1.54056</span>):</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    lattice_matrix, valid <span class="op">=</span> get_lattice_matrix(unit_cells)</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    unit_cells <span class="op">=</span> unit_cells[valid]</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    hkl <span class="op">=</span> hkl[valid]</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    reciprocal_lattice_matrix <span class="op">=</span> torch.linalg.inv(lattice_matrix)</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>    reciprocal_lattice_metric_tensor <span class="op">=</span> get_recip_lattice_metric_tensor(reciprocal_lattice_matrix)</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>    d_spacing <span class="op">=</span> get_d_spacing(reciprocal_lattice_metric_tensor, hkl)</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>    twotheta <span class="op">=</span> d_to_tt(d_spacing, wavelength)</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> twotheta</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I’ll test that using some diffraction data for a <a href="https://www.mdpi.com/2073-4352/10/1/42">Carbamazepine:Indomethacin cocrystal</a> I published a while ago. The first 3 peaks have the following Miller indices and positions:</p>
<table class="table">
<thead>
<tr class="header">
<th>h</th>
<th>k</th>
<th>l</th>
<th><span class="math inline">\(2\theta\)</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>1</td>
<td>0</td>
<td>5.322</td>
</tr>
<tr class="even">
<td>2</td>
<td>0</td>
<td>0</td>
<td>7.496</td>
</tr>
<tr class="odd">
<td>0</td>
<td>2</td>
<td>0</td>
<td>7.562</td>
</tr>
</tbody>
</table>
<p>And the unit cell is:</p>
<p>23.573194, 23.363375, 5.125218, 90.000, 88.77132, 90.000</p>
<div class="cell" data-execution_count="267">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>coXtal_unit_cell <span class="op">=</span> torch.tensor([<span class="fl">23.573194</span>, <span class="fl">23.363375</span>, <span class="fl">5.125218</span>, <span class="fl">90.000</span>, <span class="fl">88.77132</span>, <span class="fl">90.000</span>])</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>coXtal_hkl <span class="op">=</span> torch.tensor([[<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>],[<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">0</span>],[<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">0</span>]]).<span class="bu">float</span>()</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>coXtal_twotheta <span class="op">=</span> get_peak_positions(coXtal_unit_cell.reshape(<span class="dv">1</span>,<span class="dv">6</span>), coXtal_hkl.reshape(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>))</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Calculated peak positions:"</span>)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, ht <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(coXtal_hkl, coXtal_twotheta.squeeze())):</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(ht[<span class="dv">0</span>].<span class="bu">int</span>().tolist(), <span class="ss">f"</span><span class="sc">{</span>ht[<span class="dv">1</span>]<span class="sc">.</span>item()<span class="sc">:.3f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Calculated peak positions:
[1, 1, 0] 5.322
[2, 0, 0] 7.496
[0, 2, 0] 7.562</code></pre>
</div>
</div>
<p>That looks like it’s working nicely!</p>
</section>
<section id="peak-intensities" class="level2">
<h2 class="anchored" data-anchor-id="peak-intensities">Peak intensities</h2>
<p>The main contribution to the intensity of a diffraction peak is the position of the atoms within the unit cell. In terms of the PowCod database, this has already been calculated, and can be read in from the intensities array we saved earlier.</p>
<p>However, there are experimental/physical effects that can modulate these intensities. Most import is the effect of preferred orientation. There are several ways to model this, I’m choosing to implement the <a href="https://scripts.iucr.org/cgi-bin/paper?a26366">March-Dollase</a> method as I already have some code written to do this in GALLOP. This code is actually based on code from GSAS-II; see the <code>GetPrefOri</code> function in the file found <a href="https://subversion.xray.aps.anl.gov/pyGSAS/trunk/GSASIIstrMath.py">here</a>. I updated it to use pytorch, and work over a batch of multiple PXRD patterns.</p>
<p>Again, this is being implemented as a form of data augmentation, allowing our existing data to generate multiple different, but plausible, diffraction patterns.</p>
<p>Future work could extend this to use the more sophisticated spherical harmonic approach described <a href="http://scripts.iucr.org/cgi-bin/paper?S0021889897005918">here</a>.</p>
<div class="cell" data-execution_count="253">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_MD_PO_components(hkl, reciprocal_lattice_matrix, factor_stddev<span class="op">=</span><span class="fl">0.1</span>):</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    batchsize <span class="op">=</span> hkl.shape[<span class="dv">0</span>]</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    device <span class="op">=</span> hkl.device</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    dtype <span class="op">=</span> hkl.dtype</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Randomly assign the PO axis to be either [1,0,0], [0,1,0] or [0,0,1]</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    PO_axis <span class="op">=</span> torch.zeros((batchsize, <span class="dv">3</span>), device<span class="op">=</span>device, dtype<span class="op">=</span>dtype)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    PO_axis_select <span class="op">=</span> torch.randint(<span class="dv">0</span>,<span class="dv">3</span>,(batchsize,),device<span class="op">=</span>device)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    PO_axis[torch.arange(batchsize, device<span class="op">=</span>device),PO_axis_select] <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    u <span class="op">=</span> hkl <span class="op">/</span> torch.sqrt(torch.einsum(<span class="st">"bkj,bkj-&gt;bk"</span>, hkl,</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>                        torch.einsum(<span class="st">"bij,bkj-&gt;bki"</span>,</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>                        reciprocal_lattice_matrix,hkl))).unsqueeze(<span class="dv">2</span>)</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    cosP <span class="op">=</span> torch.einsum(<span class="st">"bij,bj-&gt;bi"</span>, u, torch.einsum(<span class="st">"bij,bj-&gt;bi"</span>,</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>                    reciprocal_lattice_matrix, PO_axis))</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    one_minus_cosPsqd <span class="op">=</span> <span class="fl">1.0</span><span class="op">-</span>cosP<span class="op">**</span><span class="dv">2</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    one_minus_cosPsqd[one_minus_cosPsqd <span class="op">&lt;</span> <span class="fl">0.</span>] <span class="op">*=</span> <span class="fl">0.</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>    sinP <span class="op">=</span> torch.sqrt(one_minus_cosPsqd)</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MD factor = 1 means no PO. Use a normal distribution with stddev given in argument</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># centred at 1.</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>    factor <span class="op">=</span> (torch.randn((batchsize,<span class="dv">1</span>),device<span class="op">=</span>device,dtype<span class="op">=</span>dtype) <span class="op">*</span> factor_stddev) <span class="op">+</span> <span class="fl">1.</span></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cosP, sinP, factor, PO_axis</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> apply_MD_PO_correction(intensities, cosP, sinP, factor):</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>    A_all <span class="op">=</span> (<span class="fl">1.0</span><span class="op">/</span>torch.sqrt(((factor)<span class="op">*</span>cosP)<span class="op">**</span><span class="dv">2</span><span class="op">+</span>sinP<span class="op">**</span><span class="dv">2</span><span class="op">/</span>(factor)))<span class="op">**</span><span class="dv">3</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> intensities <span class="op">*</span> A_all</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="peak-shapes" class="level2">
<h2 class="anchored" data-anchor-id="peak-shapes">Peak shapes</h2>
<p>Now that we can calculate where the peaks will be, and modulate the intensity of the peaks if we want to, we now need to think about the shape of the peaks.</p>
<p>There are several possible peak shapes that we could go for, however, in order to try to get relatively realistic results, I decided to implement full Voigt functions, and also include the <a href="https://scripts.iucr.org/cgi-bin/paper?hn0025">Finger, Cox and Jephcoat</a> correction for peak asymmetry.</p>
<p>We need to calculate a gaussian peak, a lorentzian peak and the FCJ profile, then convolve them together. Using the convolution theorem, we can do this by first Fourier transforming them, calculating their pointwise product in Fourier space, then inverse Fourier transforming the resultant product and taking the real components.</p>
<p>I also decided to implement peak broadening as a function of the peak position, using the well established U,V,W,X,Y,Z parameters described <a href="https://journals.iucr.org/j/issues/2021/06/00/gj5272/">here</a> and elsewhere.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gaussian(x, mu, sig):</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    root_two_pi <span class="op">=</span> <span class="fl">2.5066282746310002</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    peak <span class="op">=</span> (<span class="dv">1</span><span class="op">/</span>(sig<span class="op">*</span>root_two_pi))<span class="op">*</span>torch.exp(<span class="op">-</span><span class="fl">0.5</span><span class="op">*</span>(x<span class="op">-</span>mu)<span class="op">**</span><span class="dv">2</span><span class="op">/</span>sig<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> peak<span class="op">/</span>peak.<span class="bu">max</span>(dim<span class="op">=-</span><span class="dv">1</span>).values.unsqueeze(<span class="dv">2</span>)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lorentzian(x, loc, gam):</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    one_over_pi <span class="op">=</span> <span class="fl">0.3183098861837907</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    peak <span class="op">=</span> one_over_pi<span class="op">*</span>(gam<span class="op">/</span>((x <span class="op">-</span> loc)<span class="op">**</span><span class="dv">2</span><span class="op">+</span>gam<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> peak<span class="op">/</span>peak.<span class="bu">max</span>(dim<span class="op">=-</span><span class="dv">1</span>).values.unsqueeze(<span class="dv">2</span>)</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fcj(data,twotheta,shl):</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    step <span class="op">=</span> data[<span class="dv">1</span>] <span class="op">-</span> data[<span class="dv">0</span>]</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    pi_over_180 <span class="op">=</span> <span class="fl">0.017453292519943295</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    T <span class="op">=</span> step<span class="op">*</span>data<span class="op">+</span>twotheta</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    abs_cos_T <span class="op">=</span> torch.<span class="bu">abs</span>(torch.cos(T<span class="op">*</span>pi_over_180))</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    abs_cos_T_sqd <span class="op">=</span> abs_cos_T<span class="op">**</span><span class="dv">2</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    cos_sqd_twotheta <span class="op">=</span> torch.cos(twotheta<span class="op">*</span>pi_over_180)<span class="op">**</span><span class="dv">2</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>    cos_sqd_twotheta <span class="op">=</span> torch.where(abs_cos_T_sqd<span class="op">&gt;</span>cos_sqd_twotheta,</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>                                    cos_sqd_twotheta,abs_cos_T_sqd)</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>    fcj_profile <span class="op">=</span> torch.where(abs_cos_T_sqd<span class="op">&gt;</span>cos_sqd_twotheta,</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>                    (torch.sqrt(cos_sqd_twotheta<span class="op">/</span>(abs_cos_T_sqd<span class="op">-</span>cos_sqd_twotheta<span class="op">+</span><span class="fl">1e-9</span>))</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>                    <span class="op">-</span><span class="fl">1.</span><span class="op">/</span>shl)<span class="op">/</span>abs_cos_T,<span class="fl">0.0</span>)</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>    fcj_profile <span class="op">=</span> torch.where(fcj_profile <span class="op">&gt;</span> <span class="fl">0.</span>,fcj_profile,<span class="fl">0.</span>)</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fcj_profile</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_UVWZ(batchsize, device, dtype, U_min<span class="op">=</span><span class="fl">0.0001</span>, U_max<span class="op">=</span><span class="fl">0.0004</span>,</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>            V_min<span class="op">=</span><span class="fl">0.0001</span>, V_max<span class="op">=</span><span class="fl">0.0004</span>, W_min<span class="op">=</span><span class="fl">0.0001</span>, W_max<span class="op">=</span><span class="fl">0.0004</span>,</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>            Z_min<span class="op">=</span><span class="fl">0.0001</span>, Z_max<span class="op">=</span><span class="fl">0.0004</span>):</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>    U <span class="op">=</span> ((torch.rand(batchsize, device<span class="op">=</span>device, dtype<span class="op">=</span>dtype) <span class="op">*</span> (U_max<span class="op">-</span>U_min))</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>            <span class="op">+</span> U_min).unsqueeze(<span class="dv">1</span>)</span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>    V <span class="op">=</span> ((torch.rand(batchsize, device<span class="op">=</span>device, dtype<span class="op">=</span>dtype) <span class="op">*</span> (V_max<span class="op">-</span>V_min))</span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>            <span class="op">+</span> V_min).unsqueeze(<span class="dv">1</span>)</span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>    W <span class="op">=</span> ((torch.rand(batchsize, device<span class="op">=</span>device, dtype<span class="op">=</span>dtype) <span class="op">*</span> (W_max<span class="op">-</span>W_min))</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>            <span class="op">+</span> W_min).unsqueeze(<span class="dv">1</span>)</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>    Z <span class="op">=</span> ((torch.rand(batchsize, device<span class="op">=</span>device, dtype<span class="op">=</span>dtype) <span class="op">*</span> (Z_max<span class="op">-</span>Z_min))</span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>            <span class="op">+</span> Z_min).unsqueeze(<span class="dv">1</span>)</span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> U, V, W, Z</span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_XY(batchsize, device, dtype, X_min<span class="op">=</span><span class="fl">0.001</span>, X_max<span class="op">=</span><span class="fl">0.035</span>,</span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>            Y_min<span class="op">=</span><span class="fl">0.001</span>,Y_max<span class="op">=</span><span class="fl">0.035</span>):</span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> ((torch.rand(batchsize, device<span class="op">=</span>device, dtype<span class="op">=</span>dtype) <span class="op">*</span> (X_max<span class="op">-</span>X_min))</span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a>            <span class="op">+</span> X_min).unsqueeze(<span class="dv">1</span>)</span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a>    Y <span class="op">=</span> ((torch.rand(batchsize, device<span class="op">=</span>device, dtype<span class="op">=</span>dtype) <span class="op">*</span> (Y_max<span class="op">-</span>Y_min))</span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a>            <span class="op">+</span> Y_min).unsqueeze(<span class="dv">1</span>)</span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> X, Y</span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_hwhm_G(tan_twotheta, cos_twotheta, U, V, W, Z):</span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>    tan_twotheta <span class="op">=</span> tan_twotheta.squeeze()</span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>    cos_twotheta <span class="op">=</span> cos_twotheta.squeeze()</span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.sqrt((U <span class="op">*</span> tan_twotheta<span class="op">**</span><span class="dv">2</span>) <span class="op">+</span> (V <span class="op">*</span> tan_twotheta)</span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a>                        <span class="op">+</span> W <span class="op">+</span> (Z<span class="op">/</span>(cos_twotheta<span class="op">**</span><span class="dv">2</span>))).unsqueeze(<span class="dv">2</span>)</span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_hwhm_L(tan_twotheta, cos_twotheta, X, Y):</span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a>    tan_twotheta <span class="op">=</span> tan_twotheta.squeeze()</span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a>    cos_twotheta <span class="op">=</span> cos_twotheta.squeeze()</span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ((X <span class="op">*</span> tan_twotheta) <span class="op">+</span> (Y<span class="op">/</span>cos_twotheta)).unsqueeze(<span class="dv">2</span>)</span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_shl(batchsize, device, dtype, shlmax<span class="op">=</span><span class="fl">0.5</span>):</span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a>    shl <span class="op">=</span> torch.rand((batchsize, <span class="dv">1</span>, <span class="dv">1</span>), device<span class="op">=</span>device, dtype<span class="op">=</span>dtype) <span class="op">*</span> shlmax</span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> shl</span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_zero_point_error(batchsize, device, dtype, zpemin<span class="op">=</span><span class="fl">0.03</span>, zpemax<span class="op">=</span><span class="fl">0.03</span>):</span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a>    zero_point_error <span class="op">=</span> (torch.rand((batchsize,<span class="dv">1</span>,<span class="dv">1</span>), device<span class="op">=</span>device, dtype<span class="op">=</span>dtype)</span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a>                        <span class="op">*</span> (zpemax <span class="op">-</span> zpemin)) <span class="op">+</span> zpemin</span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> zero_point_error</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="misc" class="level2">
<h2 class="anchored" data-anchor-id="misc">Misc</h2>
</section>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>I used 20th-degree chebyshev polynomials to model the background. These were generated with completely random components without really trying to make them look “realistic”, and hence some of the background shapes look quite funky! However, in and amongst the unusual backgrounds, the model is learning to ignore the peaks and generate smooth functions that can model the background regardless of how it looks.</p>
<div class="cell" data-execution_count="1">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_background(batchsize, chebyshev_basis, device, dtype, bg_prm_std_max<span class="op">=</span><span class="fl">0.025</span>, bg_prm_std_min<span class="op">=</span><span class="fl">0.0</span>):</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    params <span class="op">=</span> ((torch.rand((batchsize,<span class="dv">1</span>,<span class="dv">1</span>), device<span class="op">=</span>device, dtype<span class="op">=</span>dtype) <span class="op">*</span> (bg_prm_std_max <span class="op">-</span> bg_prm_std_min)) <span class="op">+</span> bg_prm_std_min)<span class="op">*</span>torch.randn((batchsize, chebyshev_basis.shape[<span class="dv">0</span>], <span class="dv">1</span>), device<span class="op">=</span>device, dtype<span class="op">=</span>dtype)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    bg <span class="op">=</span> (params <span class="op">*</span> chebyshev_basis).<span class="bu">sum</span>(dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> bg</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>ttmin <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>ttmax <span class="op">=</span> <span class="dv">44</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>datadim <span class="op">=</span> <span class="dv">2048</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> torch.device(<span class="st">"cpu"</span>)</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>dtype <span class="op">=</span> torch.float32</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> torch.linspace(ttmin, ttmax, datadim, device<span class="op">=</span>device, dtype<span class="op">=</span>dtype)</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Background using Chebyshev polynomials</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>ttstar <span class="op">=</span> (<span class="dv">2</span><span class="op">*</span>(data <span class="op">-</span> ttmin)<span class="op">/</span>(ttmax <span class="op">-</span> ttmin)) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>degree <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> torch.arange(degree,device<span class="op">=</span>device,dtype<span class="op">=</span>dtype).unsqueeze(<span class="dv">1</span>)</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>chebyshev_basis <span class="op">=</span> torch.cos(n<span class="op">*</span>torch.arccos(ttstar))</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>batchsize <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>bgs <span class="op">=</span> get_background(batchsize, chebyshev_basis, device, dtype)</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>bgs <span class="op">-=</span> bgs.<span class="bu">min</span>(dim<span class="op">=-</span><span class="dv">1</span>).values.unsqueeze(<span class="dv">1</span>)</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">1</span>,figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">6</span>))</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> bg <span class="kw">in</span> bgs:</span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>    ax.plot(data, bg)</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"$2</span><span class="ch">\\</span><span class="st">theta$"</span>)</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Example randomly generated backgrounds"</span>)</span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-error">
<pre><code>NameError: name 'torch' is not defined</code></pre>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>